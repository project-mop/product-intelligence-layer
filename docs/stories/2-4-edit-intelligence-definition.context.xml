<story-context id="2-4-edit-intelligence-definition" v="1.0">
  <metadata>
    <epicId>2</epicId>
    <storyId>4</storyId>
    <title>Edit Intelligence Definition</title>
    <status>drafted</status>
    <generatedAt>2025-11-27</generatedAt>
    <generator>BMAD Story Context Workflow</generator>
    <sourceStoryPath>docs/stories/2-4-edit-intelligence-definition.md</sourceStoryPath>
  </metadata>

  <story>
    <asA>user</asA>
    <iWant>to edit my existing intelligence definitions</iWant>
    <soThat>I can refine and improve them over time</soThat>
    <tasks>
      <task id="1">Create Edit Page Route - src/app/dashboard/processes/[id]/edit/page.tsx</task>
      <task id="2">Add Edit Action to Intelligence Card dropdown menu</task>
      <task id="3">Implement Edit Form with Wizard State - reuse wizard step components</task>
      <task id="4">Implement Auto-save Functionality - useAutoSave hook with 1s debounce</task>
      <task id="5">Handle Published Version Editing - create new DRAFT version</task>
      <task id="6">Implement Diff View - VersionDiff component for comparing versions</task>
      <task id="7">Audit Logging for Edits - ensure process.updated audit entries</task>
      <task id="8">Write Tests - unit and integration tests</task>
      <task id="9">Verification - typecheck, lint, tests</task>
    </tasks>
  </story>

  <acceptanceCriteria>
    <criterion id="1">Edit action available on each intelligence card in the dashboard</criterion>
    <criterion id="2">Edit page loads current values into wizard form</criterion>
    <criterion id="3">Changes to DRAFT versions update in place</criterion>
    <criterion id="4">Changes to PUBLISHED versions create a new DRAFT version</criterion>
    <criterion id="5">Diff view available when editing a published intelligence</criterion>
    <criterion id="6">Auto-save triggers on field blur (debounced 1s)</criterion>
    <criterion id="7">Explicit Save button confirms all changes</criterion>
    <criterion id="8">AuditLog entry created for each save operation</criterion>
  </acceptanceCriteria>

  <artifacts>
    <docs>
      <doc>
        <path>docs/tech-spec-epic-2.md</path>
        <title>Epic 2 Technical Specification</title>
        <section>Story 2.4: Edit Intelligence Definition</section>
        <snippet>Edit flow: Load process and current draft version, display wizard UI with current values, auto-save on field blur, if editing published version create new DRAFT version with diff/comparison option.</snippet>
      </doc>
      <doc>
        <path>docs/epics.md</path>
        <title>Epic Breakdown</title>
        <section>Story 2.4: Edit Intelligence Definition</section>
        <snippet>AC: Edit action available, load current values, DRAFT updates in place, PUBLISHED edits create new draft, diff view available, auto-save debounced, explicit Save confirms, AuditLog entry created.</snippet>
      </doc>
      <doc>
        <path>docs/architecture.md</path>
        <title>Architecture</title>
        <section>tRPC Patterns, Implementation Patterns</section>
        <snippet>ADR-003: tRPC for internal dashboard operations with type-safe end-to-end. Use protectedProcedure for authenticated routes, Zod for input validation, TRPCError for error handling.</snippet>
      </doc>
      <doc>
        <path>docs/testing-strategy-mvp.md</path>
        <title>Testing Strategy</title>
        <section>Test Patterns, Component Tests</section>
        <snippet>Component tests use Vitest + Testing Library with renderWithProviders. Integration tests use tRPC test callers with real database. 50% coverage minimum for MVP.</snippet>
      </doc>
      <doc>
        <path>docs/stories/2-3-define-components-and-subcomponents.md</path>
        <title>Story 2.3 (Previous Story)</title>
        <section>Senior Developer Review, File List</section>
        <snippet>ComponentEditor and ComponentTree created for hierarchical component editing. 57 new tests added. All wizard step components available for reuse.</snippet>
      </doc>
    </docs>

    <code>
      <file>
        <path>src/server/api/routers/process.ts</path>
        <kind>router</kind>
        <symbol>processRouter</symbol>
        <lines>1-669</lines>
        <reason>Contains process.get and process.update mutations needed for edit functionality. Already includes audit logging pattern.</reason>
      </file>
      <file>
        <path>src/app/dashboard/processes/new/page.tsx</path>
        <kind>page</kind>
        <symbol>NewProcessPage</symbol>
        <lines>1-333</lines>
        <reason>Create wizard implementation to reuse. Contains StepIndicator, draft recovery, auto-save pattern, and wizard navigation.</reason>
      </file>
      <file>
        <path>src/app/dashboard/processes/page.tsx</path>
        <kind>page</kind>
        <symbol>ProcessesPage</symbol>
        <lines>1-194</lines>
        <reason>Intelligence list page with card dropdown menu. Edit action needs to be wired to navigate to edit page.</reason>
      </file>
      <file>
        <path>src/lib/wizard-storage.ts</path>
        <kind>utility</kind>
        <symbol>saveWizardDraft, loadWizardDraft, clearWizardDraft</symbol>
        <lines>1-102</lines>
        <reason>localStorage persistence for wizard auto-save. Extend for edit mode with process ID context.</reason>
      </file>
      <file>
        <path>src/components/process/types.ts</path>
        <kind>types</kind>
        <symbol>WizardData, WizardStep, StepProps, ComponentDefinition</symbol>
        <lines>1-137</lines>
        <reason>Type definitions for wizard data structure and step props. Used by all wizard step components.</reason>
      </file>
      <file>
        <path>src/components/process/steps/NameStep.tsx</path>
        <kind>component</kind>
        <symbol>NameStep</symbol>
        <reason>Reusable step component for name and description editing.</reason>
      </file>
      <file>
        <path>src/components/process/steps/InputSchemaStep.tsx</path>
        <kind>component</kind>
        <symbol>InputSchemaStep</symbol>
        <reason>Input schema step with SchemaBuilder and ComponentEditor integration.</reason>
      </file>
      <file>
        <path>src/components/process/steps/GoalStep.tsx</path>
        <kind>component</kind>
        <symbol>GoalStep</symbol>
        <reason>Goal statement step with textarea input.</reason>
      </file>
      <file>
        <path>src/components/process/steps/OutputSchemaStep.tsx</path>
        <kind>component</kind>
        <symbol>OutputSchemaStep</symbol>
        <reason>Output schema step with structured/text toggle.</reason>
      </file>
      <file>
        <path>src/components/process/steps/ReviewStep.tsx</path>
        <kind>component</kind>
        <symbol>ReviewStep</symbol>
        <reason>Review and save step with tRPC mutation call.</reason>
      </file>
      <file>
        <path>src/components/process/SchemaBuilder.tsx</path>
        <kind>component</kind>
        <symbol>SchemaBuilder</symbol>
        <reason>Visual field editor with advanced mode toggle for components.</reason>
      </file>
      <file>
        <path>src/components/process/ComponentEditor.tsx</path>
        <kind>component</kind>
        <symbol>ComponentEditor</symbol>
        <reason>Component hierarchy editor with 3-level nesting support.</reason>
      </file>
      <file>
        <path>src/components/process/ComponentTree.tsx</path>
        <kind>component</kind>
        <symbol>ComponentTree</symbol>
        <reason>Tree visualization for component hierarchy.</reason>
      </file>
      <file>
        <path>src/server/services/process/types.ts</path>
        <kind>types</kind>
        <symbol>ProcessConfig, ComponentDefinition, AttributeDefinition, DEFAULT_PROCESS_CONFIG</symbol>
        <reason>Server-side type definitions and defaults for process configuration.</reason>
      </file>
      <file>
        <path>src/server/services/audit/index.ts</path>
        <kind>service</kind>
        <symbol>createAuditLog</symbol>
        <reason>Audit logging service to record process.updated events.</reason>
      </file>
    </code>

    <dependencies>
      <node>
        <package>next</package><version>^15.2.3</version>
        <package>react</package><version>^19.0.0</version>
        <package>react-hook-form</package><version>^7.66.1</version>
        <package>@hookform/resolvers</package><version>^5.2.2</version>
        <package>zod</package><version>^3.24.2</version>
        <package>@trpc/client</package><version>^11.0.0</version>
        <package>@trpc/react-query</package><version>^11.0.0</version>
        <package>@tanstack/react-query</package><version>^5.69.0</version>
        <package>lucide-react</package><version>^0.555.0</version>
        <package>sonner</package><version>^2.0.7</version>
        <package>tailwind-merge</package><version>^3.4.0</version>
        <package>class-variance-authority</package><version>^0.7.1</version>
      </node>
      <devDependencies>
        <package>vitest</package><version>^4.0.14</version>
        <package>@testing-library/react</package><version>^16.3.0</version>
        <package>@testing-library/dom</package><version>^10.4.1</version>
        <package>@testing-library/jest-dom</package><version>^6.9.1</version>
        <package>@playwright/test</package><version>^1.57.0</version>
        <package>typescript</package><version>^5.8.2</version>
      </devDependencies>
    </dependencies>
  </artifacts>

  <interfaces>
    <interface>
      <name>process.get</name>
      <kind>tRPC query</kind>
      <signature>process.get({ id: string }) => Process & { versions: ProcessVersion[], versionCount: number, hasProductionVersion: boolean }</signature>
      <path>src/server/api/routers/process.ts:281-320</path>
    </interface>
    <interface>
      <name>process.update</name>
      <kind>tRPC mutation</kind>
      <signature>process.update({ id: string, name?: string, description?: string | null, inputSchema?: JSONSchema, outputSchema?: JSONSchema }) => Process</signature>
      <path>src/server/api/routers/process.ts:410-473</path>
    </interface>
    <interface>
      <name>WizardData</name>
      <kind>TypeScript interface</kind>
      <signature>interface WizardData { templateId?: string; name: string; description?: string; inputSchema: JSONSchema7; outputSchema: JSONSchema7; goal: string; outputType: OutputType; advancedMode?: boolean; components?: ComponentDefinition[] }</signature>
      <path>src/components/process/types.ts:54-73</path>
    </interface>
    <interface>
      <name>StepProps</name>
      <kind>TypeScript interface</kind>
      <signature>interface StepProps { data: WizardData; onDataChange: (data: Partial&lt;WizardData&gt;) => void; onNext: () => void; onBack: () => void; currentStep: WizardStep }</signature>
      <path>src/components/process/types.ts:125-136</path>
    </interface>
  </interfaces>

  <constraints>
    <constraint type="architecture">Use tRPC for all internal dashboard operations (ADR-003)</constraint>
    <constraint type="architecture">Editing a published version must create a new DRAFT version - immutable published versions</constraint>
    <constraint type="pattern">Follow react-hook-form + zodResolver pattern from existing wizard steps</constraint>
    <constraint type="pattern">Use shadcn/ui components for consistent UI</constraint>
    <constraint type="pattern">Auto-save with debounce (1s) and localStorage backup</constraint>
    <constraint type="security">All queries must filter by tenantId from session - no cross-tenant access</constraint>
    <constraint type="testing">50% coverage minimum for MVP</constraint>
    <constraint type="testing">Component tests use renderWithProviders from tests/support/render.tsx</constraint>
    <constraint type="testing">Integration tests use createAuthenticatedCaller from tests/support/trpc.ts</constraint>
    <constraint type="audit">All CRUD operations must create audit log entries via createAuditLog service</constraint>
  </constraints>

  <tests>
    <standards>
      Use Vitest for unit and integration tests. Component tests use @testing-library/react with custom renderWithProviders utility that wraps components with necessary providers (tRPC, QueryClient, Session). Integration tests use tRPC test callers against a real PostgreSQL test database. Follow Arrange-Act-Assert pattern. Test behavior not implementation. 50% coverage minimum for MVP.
    </standards>
    <locations>
      <location>tests/unit/components/process/*.test.tsx</location>
      <location>tests/unit/hooks/*.test.ts</location>
      <location>tests/integration/process-router.test.ts</location>
      <location>tests/e2e/*.spec.ts</location>
    </locations>
    <ideas>
      <idea ac="1,2">Test EditWizard component loads process data correctly via mocked tRPC query</idea>
      <idea ac="2">Test form fields are pre-populated with fetched process values</idea>
      <idea ac="3">Integration test: update DRAFT process via process.update mutation</idea>
      <idea ac="4">Integration test: editing PRODUCTION process creates new SANDBOX version</idea>
      <idea ac="5">Test VersionDiff component renders changes between two versions</idea>
      <idea ac="6">Test useAutoSave hook debounces calls by 1 second</idea>
      <idea ac="6">Test auto-save persists to localStorage on each change</idea>
      <idea ac="7">Test explicit Save button calls process.update mutation</idea>
      <idea ac="8">Integration test: verify audit log entry created after update</idea>
      <idea ac="1">Test Edit dropdown action navigates to correct URL</idea>
    </ideas>
  </tests>
</story-context>
