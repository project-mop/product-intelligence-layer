<story-context id="story-1.4-api-token-management" v="1.0">
  <metadata>
    <epicId>1</epicId>
    <storyId>4</storyId>
    <title>API Token Management</title>
    <status>done</status>
    <generatedAt>2025-11-25</generatedAt>
    <generator>BMAD Story Context Workflow</generator>
    <sourceStoryPath>docs/stories/1-4-api-token-management.md</sourceStoryPath>
  </metadata>

  <story>
    <asA>user</asA>
    <iWant>to create, view, rotate, and revoke API tokens</iWant>
    <soThat>I can securely integrate my intelligences with external systems</soThat>
    <tasks>
      <task id="1" acs="1,2,3,7">
        <title>Create API Key Service</title>
        <subtasks>
          <subtask>Create src/server/services/auth/api-key.ts</subtask>
          <subtask>Implement generateKey() - creates cryptographically secure key with prefix</subtask>
          <subtask>Implement hashKey() - SHA-256 hash for storage</subtask>
          <subtask>Implement createApiKey() - stores hashed key, returns plaintext once</subtask>
          <subtask>Key format: pil_{env}_{random} where env is live or test, random is 32 bytes hex</subtask>
          <subtask>Default expiration: 90 days from creation (configurable via env)</subtask>
        </subtasks>
      </task>
      <task id="2" acs="1,2,4,5,6,7">
        <title>Create API Key tRPC Router</title>
        <subtasks>
          <subtask>Create src/server/api/routers/apiKey.ts</subtask>
          <subtask>Implement list query - returns all keys for tenant (without plaintext)</subtask>
          <subtask>Implement create mutation - creates new key, returns ApiKey + plainTextKey</subtask>
          <subtask>Implement rotate mutation - revokes old key, creates new with same config</subtask>
          <subtask>Implement revoke mutation - sets revokedAt timestamp</subtask>
          <subtask>Implement update mutation - update name only (scopes in future epic)</subtask>
          <subtask>Register router in src/server/api/root.ts</subtask>
        </subtasks>
      </task>
      <task id="3" acs="6,8">
        <title>Implement API Key Validation Middleware</title>
        <subtasks>
          <subtask>Create src/server/services/auth/api-key-validator.ts</subtask>
          <subtask>Implement validateApiKey(authHeader) - extracts, hashes, queries, validates</subtask>
          <subtask>Check: key exists, not revoked, not expired</subtask>
          <subtask>Return ApiKeyContext with tenantId, keyId, scopes, environment</subtask>
          <subtask>Update lastUsedAt on successful validation (fire-and-forget)</subtask>
          <subtask>Return appropriate error codes: 401 for invalid/revoked/expired</subtask>
        </subtasks>
      </task>
      <task id="4" acs="1,2,3,4,5,6">
        <title>Create API Keys Management UI</title>
        <subtasks>
          <subtask>Create src/app/dashboard/api-keys/page.tsx - list view</subtask>
          <subtask>Display table: name, environment (badge), created, last used, actions</subtask>
          <subtask>Create modal for new key creation with name and environment selection</subtask>
          <subtask>Show plaintext key ONCE with copy button and warning</subtask>
          <subtask>Add rotate button with confirmation dialog</subtask>
          <subtask>Add revoke button with confirmation dialog</subtask>
          <subtask>Show revoked keys with strikethrough or badge</subtask>
        </subtasks>
      </task>
      <task id="5" acs="all">
        <title>Write Audit Log Entries</title>
        <note>Deferred to Story 1.5 - audit infrastructure not yet available</note>
        <subtasks>
          <subtask>Log apiKey.created on key creation</subtask>
          <subtask>Log apiKey.rotated on key rotation (include old key ID)</subtask>
          <subtask>Log apiKey.revoked on key revocation</subtask>
          <subtask>Include IP address and user agent in audit context</subtask>
        </subtasks>
      </task>
      <task id="6" acs="1-8">
        <title>Testing</title>
        <subtasks>
          <subtask>Unit tests for key generation (format, uniqueness)</subtask>
          <subtask>Unit tests for key hashing (deterministic)</subtask>
          <subtask>Unit tests for validation logic (expired, revoked, invalid)</subtask>
          <subtask>Integration tests for CRUD operations</subtask>
          <subtask>Test token expiration behavior</subtask>
        </subtasks>
      </task>
      <task id="7" acs="1-8">
        <title>Verification</title>
        <subtasks>
          <subtask>Run pnpm typecheck - zero errors</subtask>
          <subtask>Run pnpm lint - zero warnings</subtask>
          <subtask>Run pnpm build - successful build</subtask>
          <subtask>Run pnpm test - all tests pass</subtask>
          <subtask>Manual testing of key lifecycle</subtask>
        </subtasks>
      </task>
    </tasks>
  </story>

  <acceptanceCriteria>
    <criterion id="1">User can create a new API token from dashboard</criterion>
    <criterion id="2">Token is displayed only once at creation; cannot be retrieved later</criterion>
    <criterion id="3">Token includes environment prefix (pil_live_, pil_test_)</criterion>
    <criterion id="4">User can view list of tokens with: name, created date, last used, environment</criterion>
    <criterion id="5">User can rotate a token; old token immediately invalid, new token works</criterion>
    <criterion id="6">User can revoke a token; token immediately returns 401 on use</criterion>
    <criterion id="7">Tokens have configurable expiration (default 90 days)</criterion>
    <criterion id="8">Expired tokens return 401 with clear error message</criterion>
  </acceptanceCriteria>

  <artifacts>
    <docs>
      <doc>
        <path>docs/tech-spec-epic-1.md</path>
        <title>Epic 1 Technical Specification</title>
        <section>Story 1.4: API Token Management</section>
        <snippet>Comprehensive API key service interface, tRPC router procedures, key validation flow, and security requirements including SHA-256 hashing, 90-day expiration, and immediate revocation.</snippet>
      </doc>
      <doc>
        <path>docs/architecture.md</path>
        <title>Architecture Document</title>
        <section>API Key Service Interface / Permission Checking Patterns</section>
        <snippet>Defines validateApiKey() pattern, ApiKeyContext interface, scope validation with process:* and process:proc_id format, and fire-and-forget lastUsedAt updates.</snippet>
      </doc>
      <doc>
        <path>docs/epics.md</path>
        <title>Epic Breakdown</title>
        <section>Story 1.4: API Token Management</section>
        <snippet>Covers FR-804 (dedicated API keys), FR-807 (Bearer auth), FR-809 (expiration), FR-810 (rotation), FR-811 (revocation). Store hashed tokens, show token only once at creation.</snippet>
      </doc>
    </docs>

    <code>
      <artifact>
        <path>src/lib/id.ts</path>
        <kind>utility</kind>
        <symbol>generateApiKeyId, ID_PREFIXES.apiKey</symbol>
        <reason>Use existing ID generation utility with "key" prefix for API key IDs</reason>
      </artifact>
      <artifact>
        <path>src/server/db.ts</path>
        <kind>database</kind>
        <symbol>db (PrismaClient)</symbol>
        <reason>Database client singleton with Prisma 7 adapter pattern for all database operations</reason>
      </artifact>
      <artifact>
        <path>prisma/schema.prisma</path>
        <kind>schema</kind>
        <symbol>ApiKey model</symbol>
        <lines>170-190</lines>
        <reason>ApiKey model already defined with keyHash, scopes, environment, expiresAt, revokedAt, lastUsedAt fields</reason>
      </artifact>
      <artifact>
        <path>src/server/api/routers/auth.ts</path>
        <kind>router</kind>
        <symbol>authRouter</symbol>
        <reason>Reference implementation for tRPC router pattern, uses randomBytes for tokens, createHash for hashing, bcrypt patterns</reason>
      </artifact>
      <artifact>
        <path>src/server/api/root.ts</path>
        <kind>router</kind>
        <symbol>appRouter</symbol>
        <reason>Must register new apiKey router here</reason>
      </artifact>
      <artifact>
        <path>src/server/services/n8n/client.ts</path>
        <kind>service</kind>
        <symbol>triggerWelcomeEmail</symbol>
        <reason>Reference pattern for service module structure</reason>
      </artifact>
    </code>

    <dependencies>
      <ecosystem name="node">
        <package name="@prisma/client" version="^7.0.1">ORM for database operations</package>
        <package name="@trpc/server" version="^11.0.0">tRPC server for type-safe API</package>
        <package name="zod" version="^3.24.2">Schema validation for inputs</package>
        <package name="bcryptjs" version="^3.0.3">Password hashing (reference, not used for API keys)</package>
        <package name="next-auth" version="5.0.0-beta.25">Authentication framework</package>
        <package name="vitest" version="^4.0.14">Test framework</package>
      </ecosystem>
      <builtins>
        <builtin name="crypto">randomBytes for key generation, createHash for SHA-256 hashing</builtin>
      </builtins>
    </dependencies>
  </artifacts>

  <interfaces>
    <interface>
      <name>ApiKeyService</name>
      <kind>service interface</kind>
      <signature>
interface ApiKeyService {
  generate(params: {
    tenantId: string;
    name: string;
    scopes: string[];
    environment: 'SANDBOX' | 'PRODUCTION';
    expiresAt?: Date;
  }): Promise&lt;{ apiKey: ApiKey; plainTextKey: string }&gt;;

  validate(authHeader: string | null): Promise&lt;ApiKeyContext&gt;;

  assertProcessAccess(ctx: ApiKeyContext, processId: string): void;

  rotate(keyId: string, tenantId: string): Promise&lt;{ apiKey: ApiKey; plainTextKey: string }&gt;;

  revoke(keyId: string, tenantId: string): Promise&lt;void&gt;;
}
      </signature>
      <path>docs/tech-spec-epic-1.md</path>
    </interface>
    <interface>
      <name>ApiKeyContext</name>
      <kind>type interface</kind>
      <signature>
interface ApiKeyContext {
  tenantId: string;
  keyId: string;
  scopes: string[];
  environment: 'SANDBOX' | 'PRODUCTION';
}
      </signature>
      <path>docs/architecture.md</path>
    </interface>
    <interface>
      <name>apiKey tRPC router</name>
      <kind>tRPC router</kind>
      <signature>
| Procedure | Type | Input | Output |
| list | query | - | ApiKey[] |
| create | mutation | {name, scopes?, environment, expiresAt?} | {apiKey, plainTextKey} |
| rotate | mutation | {id} | {apiKey, plainTextKey} |
| revoke | mutation | {id} | {success} |
| update | mutation | {id, name?, scopes?} | {apiKey} |
      </signature>
      <path>docs/tech-spec-epic-1.md</path>
    </interface>
  </interfaces>

  <constraints>
    <constraint category="security">
      <rule>FR-804: Store SHA-256 hash only, never plaintext token</rule>
      <rule>FR-807: Use Bearer token authentication (Authorization: Bearer pil_live_...)</rule>
      <rule>FR-809: Default 90-day expiration, configurable via API_KEY_DEFAULT_EXPIRY_DAYS env var</rule>
      <rule>FR-810: Rotation must atomically revoke old and create new key</rule>
      <rule>FR-811: Revocation must be immediate - check revokedAt on every validation</rule>
    </constraint>
    <constraint category="architecture">
      <rule>Follow existing tRPC router pattern from src/server/api/routers/auth.ts</rule>
      <rule>Use protectedProcedure for all apiKey router procedures (requires authenticated session)</rule>
      <rule>Always filter by tenantId from session context - never trust client-provided tenantId</rule>
      <rule>Use fire-and-forget pattern for lastUsedAt updates</rule>
    </constraint>
    <constraint category="naming">
      <rule>Key format: pil_{env}_{random} where env is "live" or "test", random is 32 bytes hex (64 chars)</rule>
      <rule>API key IDs use "key_" prefix from ID_PREFIXES</rule>
      <rule>File naming: kebab-case (api-key.ts, api-key-validator.ts)</rule>
    </constraint>
    <constraint category="patterns">
      <rule>Use crypto.randomBytes(32).toString('hex') for secure random token generation</rule>
      <rule>Use crypto.createHash('sha256').update(token).digest('hex') for hashing</rule>
      <rule>Use Prisma transactions for atomic operations (rotate)</rule>
    </constraint>
  </constraints>

  <tests>
    <standards>
      Testing uses Vitest (v4.0.14) for all unit and integration tests. Tests are located in the tests/ directory with unit/ and integration/ subdirectories. Follow patterns from existing tests. Use @testing-library/react for component testing. Run tests with pnpm test or pnpm test:watch for development.
    </standards>
    <locations>
      <location>tests/unit/</location>
      <location>tests/integration/</location>
    </locations>
    <ideas>
      <idea ac="1,2,3">Test key generation produces correct format (pil_live_/pil_test_ prefix + 64 hex chars)</idea>
      <idea ac="2">Test that plainTextKey is only available at creation, not retrievable from database</idea>
      <idea ac="4">Test list query returns all tenant keys without plaintext, includes all metadata fields</idea>
      <idea ac="5">Test rotation: old key validation fails immediately, new key works</idea>
      <idea ac="6">Test revocation: revoked key returns 401 immediately</idea>
      <idea ac="7">Test default 90-day expiration applied when expiresAt not specified</idea>
      <idea ac="8">Test expired keys return 401 with clear error message distinguishing from revoked</idea>
      <idea ac="all">Test tenant isolation: user A cannot see/modify user B's keys</idea>
      <idea ac="security">Test hash determinism: same key always produces same hash</idea>
      <idea ac="security">Test key uniqueness: collision detection on keyHash</idea>
    </ideas>
  </tests>
</story-context>
